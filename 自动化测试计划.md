# FilterCamera 自动化测试计划

> 创建时间: 2026-01-15
> 更新时间: 2026-01-16
> 关联文档: 开发计划.md
> 版本: v2.0.0

---

## 一、测试策略

### 1.1 测试金字塔

```
          /\
         /  \        E2E Tests (10%)
        /____\       - 完整用户流程
       /      \
      /        \     Integration Tests (20%)
     /__________\    - 模块间交互
    /            \
   /              \  Unit Tests (70%)
  /________________\ - 独立组件测试
```

### 1.2 测试范围

| 层级 | 测试类型 | 覆盖目标 |
|-----|---------|---------|
| Domain | Unit Test | UseCase、Model |
| Data | Unit Test + Integration | Repository、DataSource |
| Presentation | UI Test | ViewModel、Compose |
| Native | Integration Test | JNI调用 |

---

## 二、单元测试计划

### 2.1 Domain层测试

```kotlin
// TakePhotoUseCaseTest.kt
class TakePhotoUseCaseTest {
    @Test
    fun `takePhoto should return success when camera is ready`()
    @Test
    fun `takePhoto should return error when camera is not initialized`()
    @Test
    fun `takePhoto should apply current filter`()
}

// ApplyFilterUseCaseTest.kt
class ApplyFilterUseCaseTest {
    @Test
    fun `applyFilter should change current filter type`()
    @Test
    fun `applyFilter with NONE should remove filter`()
}
```

### 2.2 Data层测试

```kotlin
// CameraRepositoryImplTest.kt
class CameraRepositoryImplTest {
    @Test
    fun `startPreview should initialize camera`()
    @Test
    fun `stopPreview should release resources`()
    @Test
    fun `switchCamera should toggle between front and back`()
}

// MediaRepositoryImplTest.kt
class MediaRepositoryImplTest {
    @Test
    fun `savePhoto should save to MediaStore`()
    @Test
    fun `saveVideo should create valid mp4 file`()
}
```

### 2.3 ViewModel测试

```kotlin
// CameraViewModelTest.kt
class CameraViewModelTest {
    @Test
    fun `initial state should be Idle`()
    @Test
    fun `onTakePhoto should emit Capturing state`()
    @Test
    fun `onFilterSelected should update current filter`()
    @Test
    fun `onBeautyLevelChanged should update beauty level`()
}
```

---

## 三、集成测试计划

### 3.1 CameraX集成测试

```kotlin
@RunWith(AndroidJUnit4::class)
class CameraXIntegrationTest {
    @Test
    fun cameraPreview_shouldBindSuccessfully()
    @Test
    fun imageCapture_shouldSaveToFile()
    @Test
    fun videoRecording_shouldCreateValidFile()
}
```

### 3.2 OpenGL集成测试

```kotlin
@RunWith(AndroidJUnit4::class)
class OpenGLIntegrationTest {
    @Test
    fun gpuFilter_shouldRenderCorrectly()
    @Test
    fun beautyFilter_shouldApplyEffect()
    @Test
    fun filterSwitch_shouldNotCrash()
}
```

---

## 四、UI测试计划 (Compose)

### 4.1 CameraScreen测试

```kotlin
@RunWith(AndroidJUnit4::class)
class CameraScreenTest {
    @get:Rule
    val composeTestRule = createComposeRule()

    @Test
    fun cameraScreen_displaysPreview() {
        composeTestRule.setContent { CameraScreen() }
        composeTestRule.onNodeWithTag("camera_preview").assertIsDisplayed()
    }

    @Test
    fun shutterButton_triggersCapture() {
        composeTestRule.setContent { CameraScreen() }
        composeTestRule.onNodeWithTag("shutter_button").performClick()
        // 验证拍照触发
    }

    @Test
    fun filterSelector_showsAllFilters() {
        composeTestRule.setContent { CameraScreen() }
        composeTestRule.onNodeWithTag("filter_button").performClick()
        composeTestRule.onNodeWithTag("filter_selector").assertIsDisplayed()
    }
}
```

### 4.2 FilterSelector测试

```kotlin
class FilterSelectorTest {
    @Test
    fun filterSelector_displaysAllFilterTypes()
    @Test
    fun filterSelector_highlightsSelectedFilter()
    @Test
    fun filterClick_triggersCallback()
}
```

---

## 五、E2E测试计划

### 5.1 完整拍照流程

```kotlin
@RunWith(AndroidJUnit4::class)
@LargeTest
class TakePhotoE2ETest {
    @get:Rule
    val activityRule = ActivityScenarioRule(MainActivity::class.java)

    @Test
    fun completePhotoFlow() {
        // 1. 授予相机权限
        grantCameraPermission()

        // 2. 等待相机预览
        waitForCameraPreview()

        // 3. 选择滤镜
        selectFilter(FilterType.FAIRYTALE)

        // 4. 设置美颜等级
        setBeautyLevel(3)

        // 5. 拍照
        clickShutterButton()

        // 6. 验证照片保存
        verifyPhotoSaved()
    }
}
```

### 5.2 完整录像流程

```kotlin
@Test
fun completeVideoFlow() {
    // 1. 切换到录像模式
    switchToVideoMode()

    // 2. 开始录制
    startRecording()

    // 3. 等待5秒
    waitFor(5000)

    // 4. 停止录制
    stopRecording()

    // 5. 验证视频保存
    verifyVideoSaved()
}
```

---

## 六、性能测试计划

### 6.1 渲染帧率测试

```kotlin
@Test
fun frameRate_shouldMaintain30fps() {
    val frameRates = measureFrameRates(duration = 10_000)
    val avgFps = frameRates.average()
    assertTrue("Average FPS should be >= 30", avgFps >= 30)
}
```

### 6.2 内存泄漏测试

```kotlin
@Test
fun memoryLeak_shouldNotOccurOnRotation() {
    repeat(10) {
        rotateDevice()
        waitFor(1000)
    }
    val leaks = LeakCanary.getLeaks()
    assertTrue("Should have no memory leaks", leaks.isEmpty())
}
```

---

## 七、测试执行命令

```bash
# 运行所有单元测试
./gradlew testDebugUnitTest

# 运行所有Instrumentation测试
./gradlew connectedDebugAndroidTest

# 运行Lint检查
./gradlew lintDebug

# 生成测试覆盖率报告
./gradlew jacocoTestReport
```

---

## 八、测试检查清单

### 编译阶段
- [ ] `./gradlew assembleDebug` 成功
- [ ] `./gradlew lintDebug` 无严重警告
- [ ] Native库编译成功

### 功能测试
- [ ] 相机预览正常显示
- [ ] 前后摄像头切换正常
- [ ] 拍照功能正常
- [ ] 录像功能正常
- [ ] 42种滤镜全部可用
- [ ] 美颜等级调节正常
- [ ] 照片保存到相册正常
- [ ] 视频保存正常

### 权限测试
- [ ] 相机权限申请正常
- [ ] 存储权限申请正常
- [ ] 权限拒绝时提示正常

### 兼容性测试
- [ ] Android 7.0 (API 24) 正常
- [ ] Android 10 (API 29) 正常
- [ ] Android 13 (API 33) 正常
- [ ] Android 14 (API 34) 正常
- [ ] Android 16 (API 36) 正常

---

---

## 九、ADB模拟器测试（实际执行）

### 9.1 模拟器环境
| 项目 | 值 |
|-----|-----|
| 设备ID | emulator-5554 |
| 设备名称 | Android_16 |
| 系统镜像 | google_apis (API 36) |
| 分辨率 | 1080x2400 |

### 9.2 启动与基础测试

```bash
# 启动应用（Debug包名带.debug后缀）
adb -s emulator-5554 shell am start -n com.qihao.filtercamera.debug/com.qihao.filtercamera.MainActivity

# 获取UI结构
adb -s emulator-5554 shell uiautomator dump /sdcard/ui.xml
adb -s emulator-5554 pull /sdcard/ui.xml ./ui.xml

# 截图验证
adb -s emulator-5554 shell screencap /sdcard/screen.png
adb -s emulator-5554 pull /sdcard/screen.png ./screen.png

# 监控crash日志
adb -s emulator-5554 logcat -d | grep -E "(FATAL|AndroidRuntime|crash)"
```

### 9.3 UI操作测试

```bash
# 点击操作 (tap X Y)
adb -s emulator-5554 shell input tap 540 2100    # 拍照按钮
adb -s emulator-5554 shell input tap 270 1900    # 模式Tab-拍照
adb -s emulator-5554 shell input tap 540 1900    # 模式Tab-录像
adb -s emulator-5554 shell input tap 810 1900    # 模式Tab-专业

# 滑动操作 (swipe X1 Y1 X2 Y2 duration)
adb -s emulator-5554 shell input swipe 300 1200 800 1200 300  # 横向滑动

# 长按操作
adb -s emulator-5554 shell input swipe 540 2100 540 2100 2000  # 长按录像
```

### 9.4 测试用例执行记录

| ID | 测试项 | 命令/操作 | 预期结果 | 实际结果 | 状态 |
|----|-------|---------|---------|---------|------|
| E1 | 应用启动 | am start | Activity显示 | - | ⬜ |
| E2 | 拍照模式 | tap拍照Tab | 切换成功 | - | ⬜ |
| E3 | 录像模式 | tap录像Tab | 切换成功 | - | ⬜ |
| E4 | 专业模式 | tap专业Tab | 切换成功 | - | ⬜ |
| E5 | 滤镜打开 | tap滤镜按钮 | 面板显示 | - | ⬜ |
| E6 | 滤镜选择 | tap滤镜项 | 预览变化 | - | ⬜ |
| E7 | 滤镜关闭 | tap关闭 | 面板隐藏 | - | ⬜ |
| E8 | 稳定性 | 循环切换 | 无crash | - | ⬜ |

---

**文档版本**: v2.0
**最后更新**: 2026-01-16
